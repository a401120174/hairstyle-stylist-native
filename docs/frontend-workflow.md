# 前端使用流程

## 概述

本文件詳細說明 Hairstyle Stylist Native 應用的前端業務流程，包括 API 調用、Firebase 整合、iOS 內購等核心功能的實作流程。

## 應用啟動流程

### 1. 應用初始化

**Firebase 服務初始化：**
- 載入 Firebase 配置並初始化各項服務
- 建立 Auth、Functions、Firestore 連接
- 根據環境自動切換到 Emulator 或正式服務

**用戶認證流程：**
- 檢查本地儲存的用戶狀態
- 執行匿名登入，確保用戶身份
- 初始化用戶上下文和狀態管理

**應用狀態恢復：**
- 從 AsyncStorage 載入用戶偏好設定
- 初始化應用主題和語言設定
- 恢復上次的應用狀態

### 2. 主頁面載入

**導航系統初始化：**
- Expo Router 自動處理路由配置
- 載入根布局組件和頁面結構
- 設定螢幕轉換動畫和手勢

**資料同步：**
- 從伺服器同步用戶點數資訊
- 載入交易歷史和使用記錄
- 更新本地快取資料

## 核心業務流程

### 1. 髮型生成功能

**流程步驟：**

1. **圖片選擇階段**
   - 用戶選擇拍照或從相簿選取
   - 調用 `expo-image-picker` API
   - 處理相機和儲存權限請求
   - 圖片壓縮和格式驗證

2. **預處理階段**
   - 檢查用戶點數餘額
   - 驗證圖片格式和大小
   - 顯示載入狀態和進度指示

3. **API 調用階段**
   - 調用 `tryHairstyle` Firebase Function
   - 上傳圖片資料到雲端處理
   - 等待 AI 處理結果

4. **結果處理階段**
   - 接收處理後的髮型圖片
   - 更新用戶點數餘額
   - 儲存結果到本地快取
   - 顯示成功或錯誤訊息

**錯誤處理：**
- 網路連接異常處理
- 點數不足提示和導引
- 圖片處理失敗重試機制
- 用戶友善的錯誤訊息顯示

### 2. 點數系統管理

**點數查詢流程：**

1. **即時查詢**
   - 調用 `getUserCredits` API
   - 獲取最新的點數餘額
   - 同步伺服器端資料

2. **本地快取**
   - 將點數資訊儲存到本地狀態
   - 減少不必要的 API 調用
   - 提供離線時的資料顯示

3. **自動刷新**
   - 在關鍵操作後自動更新點數
   - 定期背景同步機制
   - 避免資料不一致問題

**狀態管理：**
- 使用 Context API 進行全域狀態管理
- 點數變化的即時 UI 更新
- 多組件間的狀態同步

### 3. iOS 內購系統

**購買流程：**

1. **商品資訊載入**
   - 查詢 App Store 的內購商品
   - 顯示商品價格和描述
   - 處理地區價格差異

2. **購買發起**
   - 調用 iOS 內購 API
   - 處理用戶確認和授權
   - 監聽購買狀態變化

3. **收據驗證**
   - 獲取 App Store 交易收據
   - 調用 `verifyIosPurchase` API
   - 後端驗證收據真實性

4. **點數發放**
   - 伺服器端更新用戶點數
   - 前端同步最新點數資料
   - 顯示購買成功確認

**安全機制：**
- 收據在伺服器端驗證，防止偽造
- 重複購買檢測和處理
- 交易狀態的完整記錄

### 4. 交易歷史管理

**資料展示：**
- 分頁載入交易記錄
- 按時間排序的交易列表
- 不同交易類型的圖示和說明

**資料同步：**
- 從伺服器獲取完整交易歷史
- 本地快取常用資料
- 增量更新機制

## API 調用架構

### 1. 服務層設計

**統一的 API 服務：**
- 基於 Firebase Functions 的 HTTP 可調用函數
- 標準化的請求和回應格式
- 自動的錯誤處理和重試機制

**類型安全：**
- TypeScript 介面定義
- 編譯時期的類型檢查
- IDE 自動完成和錯誤提示

### 2. 錯誤處理策略

**分層錯誤處理：**
- API 層：網路和伺服器錯誤
- 業務層：邏輯和驗證錯誤
- UI 層：用戶介面和體驗錯誤

**用戶友善提示：**
- 本地化的錯誤訊息
- 具體的解決建議
- 適當的重試和替代方案

### 3. 快取策略

**多層快取機制：**
- 記憶體快取：即時資料存取
- 本地儲存：跨會話資料保存
- 伺服器快取：減少重複計算

**資料同步：**
- 樂觀更新：立即更新 UI
- 背景同步：確保資料一致性
- 衝突解決：處理併發更新

## 狀態管理架構

### 1. Context API 使用

**認證上下文：**
- 全域的用戶認證狀態
- 登入/登出狀態管理
- 用戶資訊的集中存取

**業務上下文：**
- 點數系統狀態管理
- 交易歷史資料管理
- 應用設定和偏好

### 2. Hook 設計模式

**自訂 Hook：**
- `useCredits`：點數相關邏輯
- `useHairstyleGenerator`：髮型生成邏輯
- `useIAPManager`：內購管理邏輯
- `useApiError`：錯誤處理邏輯

**邏輯復用：**
- 將複雜邏輯封裝成可重用的 Hook
- 提供簡潔的組件介面
- 便於單元測試和維護

### 3. 本地儲存管理

**AsyncStorage 使用：**
- 用戶偏好設定儲存
- 快取資料的持久化
- 離線模式的資料支援

**資料結構：**
- JSON 格式的結構化資料
- 版本控制和遷移策略
- 資料清理和維護機制

## 使用者體驗優化

### 1. 載入狀態管理

**進度指示：**
- 全域載入狀態顯示
- 具體操作的進度回饋
- 估計時間和剩餘步驟

**骨架屏幕：**
- 內容載入前的佔位元素
- 平滑的過渡動畫
- 減少用戶等待焦慮

### 2. 離線支援

**快取策略：**
- 關鍵資料的本地快取
- 離線模式的功能限制
- 網路恢復後的資料同步

**用戶提示：**
- 網路狀態的即時顯示
- 離線功能的說明
- 資料同步狀態的反饋

### 3. 性能優化

**資源管理：**
- 圖片的懶載入和壓縮
- 不必要 API 調用的避免
- 記憶體使用的優化

**渲染優化：**
- React 的 memo 和 callback 優化
- 虛擬列表的使用
- 動畫性能的調校

## 安全考量

### 1. 資料保護

**傳輸安全：**
- HTTPS 的強制使用
- 敏感資料的加密傳輸
- API Token 的安全管理

**本地儲存安全：**
- 敏感資料的加密儲存
- 設備鎖定保護
- 資料清理機制

### 2. 業務安全

**防作弊機制：**
- 伺服器端的業務邏輯驗證
- 重複操作的檢測和限制
- 異常行為的監控和處理

**權限控制：**
- 功能權限的細粒度控制
- 資料存取的授權檢查
- 操作記錄的完整追蹤